<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Reactive Deer AI Game - Immediate Response System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #222;
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        #gameArea {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            font-family: 'Courier New', monospace;
            font-size: 24px;
            line-height: 24px;
            letter-spacing: 0;
            word-spacing: 0;
            white-space: pre;
            overflow: hidden;
            
            /* Pixel perfect rendering */
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            text-rendering: optimizeSpeed;
            
            border: none;
            outline: none;
            transform: translateZ(0);
            backface-visibility: hidden;
            font-variant-ligatures: none;
            text-decoration: none;
        }

        .symbol {
            display: inline;
            font-family: 'Courier New', monospace;
            font-size: 24px;
            line-height: 24px;
            font-weight: normal;
            margin: 0;
            padding: 0;
            border: 0;
            vertical-align: baseline;
            letter-spacing: 0;
            word-spacing: 0;
        }

        /* Player */
        .player {
            color: #ff6b6b !important;
            text-shadow: 0 0 2px #ff6b6b;
            font-weight: bold;
        }

        /* REACTIVE: Enhanced deer entity styles */
        .deer-entity {
            color: #daa520 !important;
            text-shadow: 0 0 1px #daa520;
            font-weight: bold;
        }

        .deer-entity.deer-fleeing {
            color: #ffd700 !important;
            text-shadow: 0 0 2px #ffd700;
            animation: deer-panic 0.4s ease-in-out infinite alternate;
        }

        .deer-entity.deer-reacting {
            color: #ffaa00 !important;
            text-shadow: 0 0 3px #ffaa00;
            animation: deer-reacting 0.2s ease-in-out infinite alternate;
        }

        @keyframes deer-panic {
            from { 
                color: #ffd700;
                text-shadow: 0 0 2px #ffd700;
            }
            to { 
                color: #ffed4e;
                text-shadow: 0 0 4px #ffed4e;
            }
        }

        @keyframes deer-reacting {
            from { 
                color: #ffaa00;
                text-shadow: 0 0 2px #ffaa00;
            }
            to { 
                color: #ffcc33;
                text-shadow: 0 0 3px #ffcc33;
            }
        }

        .deer-vision {
            background-color: rgba(218, 165, 32, 0.2) !important;
        }

        .deer-vision-player {
            background-color: rgba(255, 0, 0, 0.3) !important;
        }

        /* Terrain colors */
        .terrain-grass { color: #00ff00; }
        .terrain-grass-1 { color: #00e600; }
        .terrain-grass-2 { color: #00ff00; }
        .terrain-grass-3 { color: #1aff1a; }
        .terrain-grass-4 { color: #00cc00; }
        .terrain-grass-5 { color: #00b300; }
        .terrain-grass-6 { color: #33ff33; }
        .terrain-grass-7 { color: #00d900; }
        .terrain-grass-8 { color: #26ff26; }

        /* Tree features */
        .tree_trunk { color: #8b4513 !important; }
        .tree_canopy { color: #008000 !important; }
        .feature-tree-trunk { color: #8b4513 !important; }
        .feature-tree-canopy { color: #008000 !important; }

        /* Other terrain types */
        .terrain-tree { color: #008000; }
        .terrain-hills { color: #a0522d; }
        .terrain-stone { color: #808080; }
        .terrain-water { color: #0080ff; }
        .terrain-path { color: #daa520; }
        .terrain-road { color: #8b4513; }
        .terrain-building { color: #654321; }
        .terrain-village { color: #ffa500; }
        .terrain-unknown { color: #404040; }

        /* Fog of War colors */
        .terrain-fog { color: #202020; }
        .terrain-explored { opacity: 0.6; }

        /* Status bar */
        .status {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(34, 34, 34, 0.9);
            display: flex;
            gap: 20px;
            padding: 10px 20px;
            border-top: 1px solid #444;
            z-index: 1000;
            font-size: 14px;
        }

        .status span {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
        }

        .status .available {
            background: #1a4d1a;
            color: #4f4;
        }

        .status .unavailable {
            background: #4d1a1a;
            color: #f44;
        }

        .facing-info {
            background: rgba(64, 64, 64, 0.8);
            color: #ccc;
        }

        .instructions {
            position: fixed;
            top: 10px;
            left: 10px;
            color: rgba(170, 170, 170, 0.8);
            font-style: italic;
            font-size: 12px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 3px;
            max-width: 700px;
        }

        .instructions.fade-out {
            animation: fadeOut 2s ease-in-out 8s forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                pointer-events: none;
            }
        }

        .reactive-indicator {
            position: fixed;
            top: 50px;
            right: 10px;
            background: rgba(255, 170, 0, 0.8);
            color: black;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1001;
            animation: fade-in-out 2s ease-in-out;
        }

        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateX(20px); }
            50% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(-20px); }
        }
    </style>
</head>
<body>
    <div id="gameArea">Loading Reactive Deer AI...</div>
    
    <div class="instructions fade-out">
        <strong>ðŸŽ® REACTIVE DEER AI GAME</strong><br>
        <strong>Movement:</strong> Arrow Keys/WASD â€¢ <strong>Fog:</strong> F â€¢ <strong>Vision:</strong> +/- â€¢ <strong>Exploration:</strong> [/]<br>
        <strong>ðŸ¦Œ DEER REACT INSTANTLY:</strong> Watch deer flee the moment you move toward them!<br>
        <strong>Debug Controls:</strong> Shift+D (debug) â€¢ Shift+S (scare all) â€¢ Shift+C (calm) â€¢ Shift+B (stats)<br>
        <strong>Terrain:</strong> 1-3 (elevation) â€¢ <strong>Water:</strong> 4-6 (dry/normal/wet) â€¢ <strong>Regenerate:</strong> Ctrl+R<br>
        <em>Try to catch a deer - they now react instantly to your every move!</em>
    </div>
        
    <div class="status">
        <span id="undoStatus">Undo: Available</span>
        <span id="redoStatus">Redo: Available</span>
        <span id="position">Position: 0, 0</span>
        <span id="facing" class="facing-info">Facing: North</span>
    </div>

    <!-- Load files in correct order -->
    <script>
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Script error:', e.error);
            const gameArea = document.getElementById('gameArea');
            if (gameArea && gameArea.innerHTML.includes('Loading')) {
                gameArea.innerHTML = 'Error loading game. Check console for details.';
            }
        });

        // Performance monitoring for reactive system
        window.deerReactionStats = {
            totalReactions: 0,
            averageReactionTime: 0,
            lastPlayerMove: 0
        };
    </script>

    <!-- Core command system -->
    <script src="src/commands/command-base.js"></script>
    <script src="src/commands/move-command.js"></script>
    
    <!-- Entity system -->
    <script src="src/entities/game-object.js"></script>
    <script src="src/entities/deer.js"></script>
    
    <!-- Terrain module system -->
    <script src="src/systems/terrain-modules/terrain-module-base.js"></script>
    <script src="src/systems/terrain-modules/elevation-module.js"></script>
    <script src="src/systems/terrain-modules/hydrology-module.js"></script>
    
    <!-- World generation system -->
    <script src="src/systems/simple-world-generator.js"></script>
    <script src="src/systems/simple-terrain-classifier.js"></script>
    
    <!-- Rendering and core systems -->
    <script src="src/systems/terrain-renderer.js"></script>
    <script src="src/systems/deer-manager.js"></script>
    <script src="src/systems/terrain-system.js"></script>
    <script src="src/systems/camera-system.js"></script>   
    <script src="src/systems/command-history.js"></script>
    
    <!-- UI and input -->
    <script src="src/ui/ui-controller.js"></script>
    <script src="src/systems/input-handler.js"></script>
    
    <!-- Game engine -->
    <script src="src/game-engine.js"></script>
    
    <!-- Initialize game -->
    <script src="src/main.js"></script>
    
    <script>
        // Initialize reactive deer system
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                if (!window.game) {
                    console.error('Game failed to initialize');
                    const gameArea = document.getElementById('gameArea');
                    if (gameArea) {
                        gameArea.innerHTML = 'Game failed to initialize. Check console for errors.';
                    }
                } else {
                    console.log('ðŸ¦Œ Reactive Deer AI Game successfully initialized!');
                    console.log('Deer now react INSTANTLY to player movement');
                    
                    // Add reactive system info
                    if (window.game.terrainSystem.deerManager) {
                        const deerCount = window.game.terrainSystem.deerManager.deer.length;
                        console.log(`${deerCount} reactive deer spawned and ready`);
                        console.log('Try moving toward a deer and watch it flee immediately!');
                        
                        // Show initial deer stats
                        setTimeout(() => {
                            const stats = window.game.terrainSystem.deerManager.getDeerBehaviorStats();
                            console.log('Initial deer positions and states:', stats);
                        }, 1000);
                    }
                }
            }, 2000);
        });

        // Add performance monitoring
        let moveCount = 0;
        const originalExecuteCommand = window.GameEngine ? window.GameEngine.prototype.executeCommand : null;
        
        if (originalExecuteCommand) {
            window.GameEngine.prototype.executeCommand = function(commandName, params) {
                if (commandName === 'move') {
                    moveCount++;
                    const moveStart = performance.now();
                    
                    // Call original method
                    const result = originalExecuteCommand.call(this, commandName, params);
                    
                    const moveEnd = performance.now();
                    const reactionTime = moveEnd - moveStart;
                    
                    // Track performance
                    window.deerReactionStats.totalReactions++;
                    window.deerReactionStats.averageReactionTime = 
                        (window.deerReactionStats.averageReactionTime + reactionTime) / 2;
                    window.deerReactionStats.lastPlayerMove = Date.now();
                    
                    // Log performance every 10 moves
                    if (moveCount % 10 === 0) {
                        console.log(`Movement #${moveCount} - Reaction time: ${reactionTime.toFixed(2)}ms`);
                        if (this.terrainSystem.deerManager) {
                            const perfInfo = this.terrainSystem.deerManager.getPerformanceInfo();
                            console.log(`Deer performance: ${perfInfo.pendingReactions} pending reactions, ${perfInfo.deerNearPlayer} deer near player`);
                        }
                    }
                    
                    return result;
                } else {
                    return originalExecuteCommand.call(this, commandName, params);
                }
            };
        }
    </script>
</body>
</html>