<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Reactive Deer AI Game - Day/Night Cycle with Companion Dog</title>
    <link rel="stylesheet" href="styles/game.css">
</head>
<body>
    <div id="gameArea">Loading Day/Night Terrain System with Companion...</div>
    
    <div class="instructions fade-out">
    <strong>üéÆ REACTIVE DEER AI GAME - DAY/NIGHT CYCLE + COMPANION DOG ‚ô•</strong><br>
    <strong>Movement:</strong> Arrow Keys/WASD ‚Ä¢ <strong>Menu:</strong> M key ‚Ä¢ <strong>Fog:</strong> F<br>
    <strong>üåÖ TIME OF DAY:</strong> N (advance time) ‚Ä¢ F1-F4 (day/dusk/night/dawn) ‚Ä¢ J (time status)<br>
    <strong>üêï COMPANION DOG:</strong> C (come here!) ‚Ä¢ P (companion status)<br>
    <strong>ü¶å DEER REACT INSTANTLY:</strong> Watch deer flee the moment you move toward them!<br>
    <strong>üèîÔ∏è GEOLOGICAL TERRAIN:</strong> 7 (mountains) ‚Ä¢ 8 (hills) ‚Ä¢ 9 (plains) ‚Ä¢ 0 (volcanic)<br>
    <strong>üåûüåô DYNAMIC LIGHTING:</strong> Vision range changes with time! Day=long, Night=short<br>
    <em>Experience atmospheric day/night cycles with a loyal companion at your side!</em>
    </div>
        
    <div class="status">
        <span id="undoStatus">Undo: Available</span>
        <span id="redoStatus">Redo: Available</span>
        <span id="position">Position: 0, 0</span>
        <span id="facing" class="facing-info">Facing: North</span>
    </div>

    <div class="loading-indicator" id="loadingIndicator">
        Loading terrain modules...
    </div>

    <!-- Load files in correct dependency order -->
    <script>
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Script error:', e.error);
            const gameArea = document.getElementById('gameArea');
            if (gameArea && gameArea.innerHTML.includes('Loading')) {
                gameArea.innerHTML = 'Error loading game. Check console for details.';
            }
        });

        // Performance monitoring for reactive system
        window.deerReactionStats = {
            totalReactions: 0,
            averageReactionTime: 0,
            lastPlayerMove: 0
        };

        // Module loading tracker - UPDATED with companion system
        window.moduleLoadStatus = {
            worldSystem: false,
            fogSystem: false,
            treeSystem: false,
            deerSystem: false,
            companionSystem: false,  // NEW
            terrainSystem: false,
            menuSystem: false,
            timeSystem: false
        };

        function updateLoadingStatus(moduleName) {
            window.moduleLoadStatus[moduleName] = true;
            const loadedCount = Object.values(window.moduleLoadStatus).filter(Boolean).length;
            const totalModules = Object.keys(window.moduleLoadStatus).length;
            
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.style.display = 'block';
                indicator.textContent = `Loading modules: ${loadedCount}/${totalModules}`;
                
                if (loadedCount === totalModules) {
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 2000);
                }
            }
            
            console.log(`‚úÖ ${moduleName} loaded (${loadedCount}/${totalModules})`);
        }
    </script>

    <!-- STEP 1: Core command system (no dependencies) -->
    <!-- Load configuration FIRST before any other systems -->
    <script src="src/config/terrain-config.js"></script>
    <script src="src/commands/command-base.js"></script>
    <script src="src/commands/move-command.js"></script>
    <script src="src/systems/command-history.js"></script>
    
    <!-- STEP 2: Terrain module foundation (must load before world generators) -->
    <script src="src/systems/terrain-modules/terrain-module-base.js"></script>
    <script src="src/systems/terrain-modules/geology-module.js"></script>
    <script src="src/systems/terrain-modules/elevation-module.js"></script>
    <script src="src/systems/terrain-modules/hydrology-module.js"></script>
    <script src="src/systems/terrain-modules/vegetation-module.js"></script>
    
    <!-- STEP 3: World generation system (depends on modules) -->
    <script src="src/systems/simple-world-generator.js"></script>
    <script src="src/systems/simple-terrain-classifier.js"></script>
    
    <!-- STEP 4: Specialized subsystems -->
    <script src="src/systems/world-system.js" onload="updateLoadingStatus('worldSystem')"></script>
    <!-- Load time system BEFORE fog system since fog depends on it -->
    <script src="src/systems/time-of-day-system.js" onload="updateLoadingStatus('timeSystem')"></script>
    <script src="src/systems/fog-of-war-system.js" onload="updateLoadingStatus('fogSystem')"></script>
    <script src="src/systems/tree-system.js" onload="updateLoadingStatus('treeSystem')"></script>
    
    <!-- STEP 5: Entity system (depends on terrain being ready) -->
    <script src="src/entities/game-object.js"></script>
    <script src="src/entities/deer.js"></script>
    <script src="src/systems/deer-system.js" onload="updateLoadingStatus('deerSystem')"></script>
    
    <!-- NEW: STEP 6: Companion system (depends on entities and terrain) -->
    <script src="src/entities/companion-dog.js"></script>
    <script src="src/systems/companion-system.js" onload="updateLoadingStatus('companionSystem')"></script>
    
    <!-- STEP 7: Rendering and UI (must load before game engine) -->
    <script src="src/systems/terrain-renderer.js"></script>
    <script src="src/systems/camera-system.js"></script>
    <script src="src/ui/ui-controller.js"></script>
    <script src="src/ui/menu-system.js" onload="updateLoadingStatus('menuSystem')"></script>
    <script src="src/systems/input-handler.js"></script>
    
    <!-- STEP 8: Main terrain system coordinator (loads after all subsystems) -->
    <script src="src/systems/terrain-system.js" onload="updateLoadingStatus('terrainSystem')"></script>
    
    <!-- STEP 9: Main game engine (loads last - depends on everything) -->
    <script src="src/main.js"></script>
    <script src="src/game-engine.js"></script>
    
    <!-- Debug: Check class availability -->
    <script>
        // Test that all required classes are available before game starts
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Checking class availability...");
            
            // Check the classes that should be globally available
            const globalClasses = {
                'TERRAIN_CONFIG': window.TERRAIN_CONFIG,
                'MenuSystem': window.MenuSystem,
                'TerrainSystem': window.TerrainSystem,
                'GameEngine': window.GameEngine,
                'TimeOfDaySystem': window.TimeOfDaySystem
            };
            
            // Check classes that might be defined but not global
            const definedClasses = {
                'UIController': typeof UIController !== 'undefined',
                'InputHandler': typeof InputHandler !== 'undefined',
                'DeerSystem': typeof DeerSystem !== 'undefined',
                'CompanionSystem': typeof CompanionSystem !== 'undefined',  // NEW
                'TreeSystem': typeof TreeSystem !== 'undefined',
                'WorldSystem': typeof WorldSystem !== 'undefined',
                'FogOfWarSystem': typeof FogOfWarSystem !== 'undefined',
                'TimeOfDaySystem': typeof TimeOfDaySystem !== 'undefined',
                'CompanionDog': typeof CompanionDog !== 'undefined'  // NEW
            };
            
            console.log("Global classes:", globalClasses);
            console.log("Defined classes:", definedClasses);
            
            // Check what's missing
            const missingGlobal = [];
            const missingDefined = [];
            
            Object.entries(globalClasses).forEach(([name, value]) => {
                if (!value) missingGlobal.push(name);
            });
            
            Object.entries(definedClasses).forEach(([name, isDefined]) => {
                if (!isDefined) missingDefined.push(name);
            });
            
            if (missingGlobal.length > 0) {
                console.error("‚ùå Missing global classes:", missingGlobal);
            }
            
            if (missingDefined.length > 0) {
                console.error("‚ùå Missing defined classes:", missingDefined);
            }
            
            if (missingGlobal.length === 0 && missingDefined.length === 0) {
                console.log("‚úÖ All required classes loaded successfully");
            }
            
            // Special check for companion system
            if (typeof CompanionSystem !== 'undefined' && typeof CompanionDog !== 'undefined') {
                console.log("üêï Companion system ready!");
            } else {
                console.error("‚ùå Companion system not available");
            }
            
            // Special check for day/night system
            if (typeof TimeOfDaySystem !== 'undefined') {
                console.log("üåÖ Time of Day system ready!");
            } else {
                console.error("‚ùå TimeOfDaySystem not available");
            }
        });
    </script>
</body>
</html>